{{- $file := .Destination -}}{{/* filename of image */}}
{{- $alt := .Text -}}{{/* alt text */}}
{{- $cap := .Title -}}{{/* caption */}}

{{- $scratch := newScratch -}}
{{- $scratch.Set "classes" "image_figure" -}}

{{/* Determine if page bundles are set. */}}
{{- $bundle := .Page.Site.Params.usePageBundles -}}
{{- if eq .Page.Params.usePageBundles false -}}
  {{- $bundle = false -}}
{{- end -}}
{{- if eq .Page.Params.usePageBundles true -}}
  {{- $bundle = true -}}
{{- end -}}

{{/* Determine source of image and get attributes. */}}
{{- $image := "" -}}
{{- if strings.HasPrefix $file "http" -}}
  {{- $scratch.Add "classes" " image_external" -}}
  {{- $image = resources.GetRemote $file -}}
{{- else -}}
  {{- $scratch.Add "classes" " image_internal" -}}
  {{ $file = (path.Clean $file) }}
  {{- if eq $bundle true -}}
    {{ $image = .Page.Resources.GetMatch $file }}
    {{- if and (not $image) .Page.File -}}
      {{ $file = path.Join .Page.File.Dir $file }}
      {{ $image = resources.Get $file }}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{/*
  If Hugo has been able to access the image, it's now loaded at $image, and we
  have access to additional attributes.

  If Hugo hasn't been able to access the image, it's still loaded at $file, with
  only its path available.
*/}}

<figure>
  <picture>

    {{/* Generate alternate image format tags. */}}
    {{- with $file -}}
      {{ $name := replace $file (path.Ext $file) "" }}
      {{ $ext := slice "avif" "webp" "jxl" }}
      {{- range $ext -}}
        {{ $path := printf "%s" . | printf "%s%s" "." | printf "%s%s" $name | printf "%s" }}
        {{- if eq $bundle true -}}
          {{ $path = path.Join "/" $.Page.File.Dir $path }}
        {{- end -}}
        {{- if fileExists $path -}}
          <source srcset="{{ $path }}" type="image/{{ . }}">
        {{- end -}}
      {{- end -}}
    {{- end -}}

    {{/* Render image and attributes. */}}
    <img
      loading="lazy"
      decoding="async"
      alt="{{ htmlEscape $alt }}"
      {{ with $image }}
        class="{{ $scratch.Get "classes" }} image_processed"
        width="{{ .Width }}"
        height="{{ .Height }}"
        src="{{ .RelPermalink }}"
      {{ else }}
        class="{{ $scratch.Get "classes" }} image_unprocessed"
        src="{{ $file }}"
      {{ end }}
      {{ with $cap }}
        title="{{ htmlEscape $cap }}"
      {{ end }}
    />

    {{/* Provide caption based on image title, if it is set. */}}
    {{- with $cap -}}
      <figcaption>{{ $cap | safeHTML }}</figcaption>
    {{- end -}}

  </picture>
</figure>
